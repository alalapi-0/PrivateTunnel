# 可观测性与诊断说明（R2）

## 日志系统
- Python 运行时日志统一写入 `artifacts/logs/privatetunnel.log`，同时在终端输出。
- 日志格式包含时间、级别、模块和消息，便于交叉排查。
- 等级含义：
  - **INFO**：常规状态与流程提示。
  - **WARNING**：异常苗头或可能的配置问题（如无握手、服务未运行）。
  - **ERROR**：明确的错误或命令执行失败。

## 一键诊断菜单
- 在 `python main.py` 的主菜单中选择 `12) 诊断当前连接状态`。
- 执行步骤：
  1. 检查 `wg-quick@wg0` 服务状态。
  2. 读取 `wg show wg0 latest-handshakes`，标记近期握手与超时握手。
  3. 通过 `curl -4 -s ifconfig.me` 获取出口 IP。
  4. 使用 `socket.getaddrinfo` 解析 `github.com`，记录耗时与结果。
- 终端会给出彩色摘要，同时所有细节写入 `artifacts/logs/privatetunnel.log`。

### 诊断输出示例
```
🩺 诊断当前连接状态
→ 检查 WireGuard 服务状态…
✅ WireGuard 服务正在运行
→ 检查最近握手…
✅ abc123… 最近握手时间：2024-06-01 12:00:00（0 分钟内）
→ 检测出口 IP…
当前出口 IP：203.0.113.10
→ 测试 DNS 解析…
✅ DNS 解析成功：github.com → 140.82.112.3（45.2 ms）

诊断总结：
- 服务状态：active
- 握手：abc123… 正常
- 出口 IP：203.0.113.10
- DNS：正常
```

## 常见问题与日志排查
- **服务未启动**：日志中出现 `WireGuard 服务未在运行`，建议 `systemctl restart wg-quick@wg0` 或重新部署。
- **无握手**：日志包含 `暂无握手记录` 或 `超 10 分钟`，可能是客户端未启动、端口被封或配置错误。
- **DNS 解析失败**：日志显示 `DNS 解析失败`，可尝试更换 DNS、检查本地网络或代理。
- **出口 IP 未变化**：诊断输出的出口 IP 与预期不符，可能未走隧道或路由未生效，需检查 WireGuard 服务与防火墙。

## 建议的冒烟测试
1. 运行 `python main.py`，确认菜单出现 `诊断当前连接状态` 选项并可执行。
2. 执行诊断，检查终端与 `artifacts/logs/privatetunnel.log` 是否同时记录步骤与结果。
3. 启动连接监控后观察日志是否定期记录延迟/丢包；触发异常时日志是否包含 WARNING/ERROR。
4. 重新跑一次部署流程，确认新的日志文件生成且旧功能（如配置下载）不受影响。
