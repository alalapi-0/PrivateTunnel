# 快速使用指南 - 改进后的代码

## ✅ 所有改进已完成

代码已经按照方案完成所有改进，包括：

1. ✅ SSH超时时间从30秒增加到60秒
2. ✅ SSH命令自动重试机制（最多3次）
3. ✅ 部署监控间隔从15秒增加到30秒
4. ✅ NVIDIA驱动彻底禁用
5. ✅ SSH代理支持

## 🚀 立即开始使用

### 方法1：直接运行（已改进，更稳定）

直接运行程序，代码已经自动优化：

```powershell
python main.py
```

选择 "3) 准备本机接入 VPS 网络"

### 方法2：使用代理（推荐，如果网络不稳定）

如果您的网络仍然不稳定，可以设置SSH代理：

**PowerShell**：
```powershell
# 通过另一个VPS中转SSH（推荐）
$env:SSH_PROXY="user@your_proxy_vps:22"

# 或使用SOCKS代理（如FoxyProxy）
$env:SSH_PROXY="127.0.0.1:1080"

# 然后运行程序
python main.py
```

**Linux/Mac**：
```bash
export SSH_PROXY="user@your_proxy_vps:22"
python main.py
```

### 方法3：调整检查间隔（如果网络非常慢）

如果网络非常慢，可以增加检查间隔：

```powershell
$env:PT_DEPLOY_CHECK_INTERVAL="60"  # 设置为60秒（默认30秒）
python main.py
```

## 📊 改进效果

### 改进前
- SSH超时：30秒，经常失败
- 无重试机制：一次失败就结束
- 检查间隔：15秒，网络压力大
- NVIDIA驱动：经常阻塞部署

### 改进后
- SSH超时：60秒，更稳定
- 自动重试：最多3次，临时网络波动不影响
- 检查间隔：30秒，减少网络压力
- NVIDIA驱动：彻底禁用，不再阻塞

## 🔍 如何验证改进

运行程序后，观察日志：

1. **SSH连接更稳定**：
   - 应该看到更少的"远端命令超时"错误
   - 如果超时，会自动重试（最多3次）

2. **部署监控更智能**：
   - 检查间隔是30秒（而不是15秒）
   - SSH失败时不会立即失败，而是继续等待

3. **NVIDIA驱动不再阻塞**：
   - 部署脚本开始时会显示"彻底禁用NVIDIA驱动自动安装"
   - 不应该看到NVIDIA驱动安装的进度条

## ⚠️ 如果仍然遇到问题

### 问题1：SSH仍然超时

**解决方案**：
1. 使用代理（设置 `SSH_PROXY` 环境变量）
2. 检查网络连接：`ping 198.13.32.41`
3. 手动测试SSH：`ssh -i C:\Users\ASUS\.ssh\id_ed25519 root@198.13.32.41 "echo test"`

### 问题2：部署仍然超时

**可能原因**：
- 网络完全不可用
- VPS上的部署脚本本身有问题

**解决方案**：
1. 手动SSH到VPS检查状态
2. 查看 `/tmp/privatetunnel-wireguard.log` 了解具体问题
3. 如果部署已完成，手动下载配置文件

### 问题3：NVIDIA驱动仍然安装

**解决方案**：
1. 检查VPS上的进程：`ps aux | grep nvidia`
2. 手动禁用：`apt-mark hold nvidia-driver-* libnvidia-*`
3. 终止安装：`pkill -f nvidia-installer`

## 📝 环境变量参考

| 变量名 | 说明 | 示例 |
|--------|------|------|
| `SSH_PROXY` | SSH代理服务器 | `user@proxy_vps:22` 或 `127.0.0.1:1080` |
| `PT_DEPLOY_CHECK_INTERVAL` | 部署检查间隔（秒） | `60`（默认30） |

## 🎯 下一步

1. **立即测试**：运行程序，选择"准备本机接入 VPS 网络"
2. **观察日志**：看SSH连接是否更稳定
3. **如果成功**：配置文件会下载到 `artifacts/` 目录
4. **如果失败**：查看错误信息，尝试使用代理或手动部署

## 💡 提示

- 如果网络不稳定，**强烈建议使用代理**（设置 `SSH_PROXY`）
- 部署过程可能需要10-30分钟，请耐心等待
- 如果连续失败20次（约10分钟），程序会提示网络可能完全不可用

祝您部署顺利！🎉

